name: Jewelry VTON Training Pipeline
on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'scrape'
        type: choice
        options:
          - scrape
          - train
          - test

jobs:
  jewelry-vton:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: pip install requests replicate pillow
      
      - name: Run Scraper
        if: github.event.inputs.action == 'scrape'
        run: python scripts/scraper.py

      - name: Verify Dataset Files
        if: github.event.inputs.action == 'scrape'
        run: |
          echo "Checking dataset directory..."
          if [ -d "dataset/jewelry_images" ]; then
            echo "✓ Dataset directory exists"
            find dataset/jewelry_images -type f -name "*.jpg" | wc -l | xargs -I {} echo "✓ Found {} image files"
            ls -la dataset/jewelry_images/
          else
            echo "✗ ERROR: dataset/jewelry_images directory not found!"
            exit 1
          fi

      - name: Upload Dataset
        if: github.event.inputs.action == 'scrape'
        uses: actions/upload-artifact@v4
        with:
          name: jewelry-dataset
          path: dataset/jewelry_images/
          
      - name: Run Training
        if: github.event.inputs.action == 'train'
        env:
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        run: python scripts/train_replicate.py
